{% extends "layouts/layout2.html" %}
{% block title %}<title>問卷</title>{% endblock %}
{% block content %}

<div class="container text-center" style="padding:80px 0px">

    <section id="searchResult" style="padding-top: 0px; margin-bottom: 30px">

        <div class="row justify-content-md-center my-5">
            <div class="col-md-4">
                <header class="section-header">
                    <h2><b>問卷({{qType}})</b></h2>
                </header>
            </div>
        </div>
        <div class="row justify-content-md-center my-3">
            <div class="col-md-6">
                <h2><b>請先選取帳號，看完圖片和影片後，在最下方評分。</b></h2>
            </div>
        </div>
        <div class="row justify-content-md-center mt-5">
            <div class="col-md-4">
                <h3 id="similarTypes">選取帳號：</h3>
                <select class="form-control" id="userName" onchange="getUserUrls()"
                    style="margin-bottom: 5px; text-align-last:center; font-size:16px;">
                    <option selected="selected" disabled="disabled" style='display: none' value=''></option>
                    
                    {% for user in users %}
                    <option value={{user}}>{{forloop.counter}}. {{user}}</option>
                    
                    {% endfor %}
                </select>
            </div>
            <!-- <div class="col-md-6">
                
            </div> -->
        </div>


        <!-- <div class="row justify-content-md-center my-5">
            <div class="col-md-2 col-sm-1 mxy-1">
                <img src="https://instagram.frmq2-2.fna.fbcdn.net/v/t51.2885-15/e35/s320x320/67048117_857106008008753_7808781008172106861_n.jpg?_nc_ht=instagram.frmq2-2.fna.fbcdn.net&_nc_cat=101&oh=718a22c5dbc0a735dda1b92c48e7dafc&oe=5E7F825D" class="img-responsive img-thumbnail" alt="Responsive image">    
            </div>
            <div class="col-md-2 col-sm-1 mxy-1">
                <img src="https://instagram.frmq2-2.fna.fbcdn.net/v/t51.2885-15/e35/s320x320/67048117_857106008008753_7808781008172106861_n.jpg?_nc_ht=instagram.frmq2-2.fna.fbcdn.net&_nc_cat=101&oh=718a22c5dbc0a735dda1b92c48e7dafc&oe=5E7F825D" class="img-responsive img-thumbnail" alt="Responsive image">    
            </div>
            <div class="col-md-2 col-sm-1 mxy-1">
                <img src="https://instagram.frmq2-2.fna.fbcdn.net/v/t51.2885-15/e35/s320x320/67048117_857106008008753_7808781008172106861_n.jpg?_nc_ht=instagram.frmq2-2.fna.fbcdn.net&_nc_cat=101&oh=718a22c5dbc0a735dda1b92c48e7dafc&oe=5E7F825D" class="img-responsive img-thumbnail" alt="Responsive image">
            </div>
        </div> -->
        <section id="result" style="display:none">
            <div class="col-md-12 mt-5 mb-4">
                <h3 style="margin-top:30px;">目前帳號：<b id="selectUserName" class="finalType"></b></h3>
            </div>

            <div class="col-md-12 mb-3">
                <h5><b>本網站上次資料更新時間：{{date.today}} 00:00:00</b></h5>
            </div>
            <div id="posts" class="row justify-content-md-center mt-3">

                <div style="float:left;width:33%">
                    <img src="https://instagram.frmq2-2.fna.fbcdn.net/v/t51.2885-15/e35/s320x320/67048117_857106008008753_7808781008172106861_n.jpg?_nc_ht=instagram.frmq2-2.fna.fbcdn.net&_nc_cat=101&oh=718a22c5dbc0a735dda1b92c48e7dafc&oe=5E7F825D"
                        class="img-responsive img-thumbnail" alt="Responsive image">
                </div>
                <div style="float:left;width:33%">
                    <img src="https://instagram.frmq2-2.fna.fbcdn.net/v/t51.2885-15/e35/s320x320/67048117_857106008008753_7808781008172106861_n.jpg?_nc_ht=instagram.frmq2-2.fna.fbcdn.net&_nc_cat=101&oh=718a22c5dbc0a735dda1b92c48e7dafc&oe=5E7F825D"
                        class="img-responsive img-thumbnail" alt="Responsive image">
                </div>
                <div style="float:left;width:33%">
                    <img src="https://instagram.frmq2-2.fna.fbcdn.net/v/t51.2885-15/e35/s320x320/67048117_857106008008753_7808781008172106861_n.jpg?_nc_ht=instagram.frmq2-2.fna.fbcdn.net&_nc_cat=101&oh=718a22c5dbc0a735dda1b92c48e7dafc&oe=5E7F825D"
                        class="img-responsive img-thumbnail" alt="Responsive image">
                </div>
                <div style="float:left;width:33%">
                    <img src="https://instagram.frmq2-2.fna.fbcdn.net/v/t51.2885-15/e35/s320x320/67048117_857106008008753_7808781008172106861_n.jpg?_nc_ht=instagram.frmq2-2.fna.fbcdn.net&_nc_cat=101&oh=718a22c5dbc0a735dda1b92c48e7dafc&oe=5E7F825D"
                        class="img-responsive img-thumbnail" alt="Responsive image">
                </div>
                <div style="float:left;width:33%" class="embed-responsive embed-responsive-16by9">
                    <video autoplay loop muted class="embed-responsive-item">
                        <source
                            src="https://instagram.frmq2-1.fna.fbcdn.net/v/t50.2886-16/67450378_1551849811618169_8577720655340032590_n.mp4?_nc_ht=instagram.frmq2-1.fna.fbcdn.net&_nc_cat=105&oe=5DF076A7&oh=25ca6cd8f3dfcbd45eaf040d525f5158"
                            type="video/mp4">
                    </video>
                </div>

            </div>
            <!-- <div class="row justify-content-md-center mt-5">
                <div class="col-md-6">
                    <h3><b>請依據您看完圖片和影片在每個分類的比例的感覺，給予此帳號在每個分類分數，例如:此帳號有很多狗的圖片或影片dog:90 cat:10 food:20 fashion:0。</b></h3>
                </div>
            </div> -->
            <div class="row justify-content-md-center my-5">
                <div class="col-md-6">
                    <h3 style="margin:20px 0 0 0">評分：</h3>
                    <h5><b>請依據以上圖片、影片在
                        {% for type in types %}
                        {{  type  }}
                        {% endfor %}
                        {% if qType == "animal" %}
                            出現的比例評分。<br>例如:此帳號有很多狗的圖片影片，有一些不是狗的圖片影片，很少貓的圖片影片，dog:75 cat:10。
                        {% else %}
                            出現的比例評分。<br>例如:此帳號有很多摩托車的圖片影片，有一些不是摩托車的圖片影片，很少車子的圖片影片，car:15 cat:70。
                        {% endif %}
                    </b></h5>
                    <!-- <h5><b>請依據您看完圖片和影片後，對應以下分類，給予不同比例分數。<br>例如:此帳號有很多狗的圖片或影片dog:90 cat:10 food:20 fashion:0。</b></h5> -->
                    <!-- <h5><b>請依據您看完圖片和影片在每個分類的比例的感覺，給予此帳號在每個分類分數，例如:此帳號有很多狗的圖片或影片dog:90 cat:10 food:20 fashion:0。</b></h5> -->
                    <div id="score" class="row justify-content-md-center my-3"
                        style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center;">
                        
                        {% for type in types %}
                        <div style="margin: 5px;">
                            <h5>{{type}}</h5><input id={{type}} class="form-control" placeholder="0~100"
                                onkeyup="value=value.replace(/[^\d]/g,'') " style="width: 125px; text-align:center;">
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-primary" style="margin:30px 0 0 0"
                        onclick="submitScore()">送出</button>
                </div>
            </div>
        </section>


    </section>
</div>

<div id='postModal' class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="postContent" class="modal-body">
                
            </div>
        </div>
    </div>
</div>



<script>
    function getUserUrls() {
        userName = document.getElementById("userName").value;
        getUrl = ("/instagram/getUserUrls/" + userName);
        console.log(getUrl)

        $.ajax({
            type: "GET",
            url: getUrl,
            dateType: "json",
            async: false,
            success: function (response) {

                if (response['success']) {

                    console.log(response);
                    $('#selectUserName').empty();
                    $('#selectUserName').append(`
                        <a href="https://www.instagram.com/${userName}" target="_blank">${userName}</a>
                    `)


                    $('#posts').empty();
                    urls = response['urls']
                    urls.forEach(url => {
                        let insertStr = "<div style='float:left; width:33%; display: flex; align-items: center;' class='embed-responsive embed-responsive-16by9' ";
                        if (url['is_video']) {
                            insertStr += `onclick="showPost( '${url['video_url']}', true )" >`
                            insertStr += `<video autoplay loop muted class="embed-responsive-item"><source src=${url['video_url']} type="video/mp4" onclick="show()"></video>`;
                        } else {
                            insertStr += `onclick="showPost( '${url['display_url']}', false )" >`
                            insertStr += `<img src=${url['display_url']} class="img-responsive img-thumbnail" alt="Responsive image">`;
                        }
                        insertStr += '</div>';
                        $('#posts').append(insertStr);
                    });

                    $('#result').show()

                } else {
                    console.log(response);
                    Swal.fire({
                        type: 'warning',
                        title: 'Oops...',
                        text: response['message'],
                    })
                }

            },
            error: function (response) {
                console.log(response);
                swal("提示", "unknow error", "warning");
            },

        })
    }

    function submitScore() {
        try {
            value1 = document.getElementById("dog").value;
            value2 = document.getElementById("cat").value;
            qType = 'animal';
        }
        catch (e) {
            value1 = document.getElementById("car").value;
            value2 = document.getElementById("motorcycle").value;
            qType = 'vehicle';
            
        }
        
        userName = document.getElementById("userName").value;
        console.log(value1, value2)

        if(value1 == '' || value2 == '' || value1 < 0 || value2 < 0 ||  value1 > 100 || value2 > 100){
            Swal.fire({
                type: 'warning',
                title: '注意!',
                text: '每個分類請輸入0~100分',
            })
        }else {
            getUrl = ("/instagram/submitScore/" + userName + "/" + value1 + "/" + value2 + "/" + qType);
            console.log(getUrl)
            $.ajax({
                type: "GET",
                url: getUrl,
                dateType: "json",
                async: false,
                success: function (response) {

                    if (response['success']) {
                        Swal.fire({
                            title: '填寫成功!感謝您~',
                            text: "按下確定返回選取帳號繼續評分!",
                            icon: 'success',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: '確定'
                        }).then((result) => {
                            if (result.value) {
                                window.location = "/instagram/questionnaire_"+qType
                            }
                        })

                    } else {
                        console.log(response);
                        Swal.fire({
                            type: 'warning',
                            title: 'Oops...',
                            text: response['message'],
                        })
                    }

                },
                error: function (response) {
                    console.log(response);
                    swal("提示", "unknow error", "warning");
                },

            })
        }

    }

    function showPost(url, is_video){

        console.log(url);

        $('#postContent').empty();

        if( is_video ){
            console.log( is_video )
            
            $('#postContent').append(`
            
                <video autoplay loop muted class="embed-responsive-item" width="100%"><source src=${url} type="video/mp4"></video>
            
            `)
            
        }else{
            $('#postContent').append(`
                <img src=${url} class="img-responsive img-thumbnail" alt="Responsive image">
            `)
        }

        $('#postModal').modal('show');
        
    }

</script>

{% endblock %}